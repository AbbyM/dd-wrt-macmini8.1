#!/bin/sh

mkdir -p /tmp/wireguard

wg genkey > /tmp/wireguard/oet$1_peer$2_private
wg pubkey < /tmp/wireguard/oet$1_peer$2_private > /tmp/wireguard/oet$1_peer$2_public
PUBKEY=`nvram get oet$1_public`
PRIVKEY=`cat /tmp/wireguard/oet$1_peer$2_private`
if [ `nvram get get wan_proto` == "disabled" ]
then
	EP=`nvram get get lan_ipaddr`
else
	EP=`get_wanip`
fi
EPPORT=`nvram get get oet$1_port`
echo "[Interface]" > /tmp/wireguard/oet$1_peer$2_conf
echo "PrivateKey = $PRIVKEY" >> /tmp/wireguard/oet$1_peer$2_conf
echo "ListenPort = 51820" >> /tmp/wireguard/oet$1_peer$2_conf
echo "[Peer]" >> /tmp/wireguard/oet$1_peer$2_conf
echo "PublicKey = $PUBKEY" >> /tmp/wireguard/oet$1_peer$2_conf
echo "Endpoint = $EP:$EPPORT" >> /tmp/wireguard/oet$1_peer$2_conf
#echo "AllowedIPs = $EP" >> /tmp/wireguard/oet$1_peer$2_conf
echo "AllowedIPs = 0.0.0.0/0, ::/0" >> /tmp/wireguard/oet$1_peer$2_conf
qeencode -t svg -r client.conf -o /tmp/wireguard/oet$1_peer$2_svg